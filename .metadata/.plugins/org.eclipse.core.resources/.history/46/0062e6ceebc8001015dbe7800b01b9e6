
package com.contactapp.controller;

import java.util.HashMap;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.crypto.password.PasswordEncoder;
//import org.springframework.web.bind.annotation.CrossOrigin;
//import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.contactapp.dto.AuthRequest;
import com.contactapp.dto.ResetPasswordWithAuthRequest;
import com.contactapp.dto.UserDto;
import com.contactapp.dto.UsernameRequest;
import com.contactapp.dto.VerifySecurityRequest;
import com.contactapp.entity.User;
import com.contactapp.repository.UserRepository;
import com.contactapp.service.AuthService;
import com.contactapp.service.JwtService;

import jakarta.validation.Valid;

@RestController
@RequestMapping("/api/auth")


//@CrossOrigin(origins = "*")


public class AuthController
{

					@Autowired
    				private AuthService authService;
					
				
				
//					@Autowired	
//					private	AuthRequest authRequest;
				
				
					@Autowired
					private JwtService jwtService;
					
					@Autowired
					private UserRepository userRepository;
					
					@Autowired
					private PasswordEncoder passwordEncoder;

					@PostMapping("/signup")
					public ResponseEntity<?> signup(@Valid @RequestBody AuthRequest request)
					{
						try
						{
							UserDto user = authService.register(request);

							Map<String, Object> response = new HashMap<>();
							response.put("message", "User registered successfully");
							response.put("user", user);

							return ResponseEntity.ok(response);
						}
						catch (Exception e)
						{
							Map<String, String> error = new HashMap<>();
							error.put("error", e.getMessage());
							return ResponseEntity.badRequest().body(error);
						}
					}

					@PostMapping("/signin")
					public ResponseEntity<?> signin(@Valid @RequestBody AuthRequest request)
					{
						try
						{
							User user = authService.authenticate(request);
							String token = jwtService.generateToken(user.getUsername());

				            Map<String, Object> response = new HashMap<>();
				            response.put("token", token);
				            response.put("userId", user.getId());
				            response.put("username", user.getUsername());
				            response.put("email", user.getEmail());

				            return ResponseEntity.ok(response);
						}
						catch (Exception e)
						{
							Map<String, String> error = new HashMap<>();
							error.put("error", e.getMessage());
							return ResponseEntity.badRequest().body(error);
						}
					}
					
//					
//					public User verifySecurityAnswer(String username, String answer) {
//					    System.out.println("ğŸ” Verifying security answer for: " + username);
//					    
//					    User user = userRepository.findByUsername(username)
//					        .orElseThrow(() -> new RuntimeException("User not found"));
//					    
//					    if(!user.getSecurityAnswer().equals(answer.toLowerCase())) {
//					        throw new RuntimeException("Security answer is incorrect");
//					    }
//					    
//					    System.out.println("âœ… Security answer verified successfully");
//					    return user;
//					}
//					
				
//					
//					@PostMapping("/verify-security-answer")
//					public ResponseEntity<?> verifySecurityAnswer(@Valid @RequestBody VerifySecurityRequest request) {
//					    try {
//					        System.out.println("ğŸ” CONTROLLER: Verify security answer for: " + request.getUsername());
//					        User user = authService.verifySecurityAnswer(request.getUsername(), request.getAnswer());
//					        
//					        String token = jwtService.generateToken(user.getUsername());
//					        Map<String, Object> response = new HashMap<>();
//					        response.put("token", token);
//					        response.put("message", "Security answer verified. You can now reset password.");
//					        return ResponseEntity.ok(response);
//					    } catch (Exception e) {
//					        System.err.println("ğŸ” CONTROLLER ERROR: " + e.getMessage());
//					        Map<String, String> error = new HashMap<>();
//					        error.put("error", e.getMessage());
//					        return ResponseEntity.badRequest().body(error);
//					    }
//					}

					
					
//					@PostMapping("/get-security-question")
//					public ResponseEntity<?> getSecurityQuestion(@Valid @RequestBody UsernameRequest request) {
//					    try {
//					        System.out.println("ğŸ” CONTROLLER: Get security question for: " + request.getUsername());
//					        User user = userRepository.findByUsername(request.getUsername())
//					            .orElseThrow(() -> new RuntimeException("User not found"));
//					        
//					        Map<String, Object> response = new HashMap<>();
//					        response.put("securityQuestion", user.getSecurityQuestion());
//					        return ResponseEntity.ok(response);
//					    } catch (Exception e) {
//					        System.err.println("ğŸ” CONTROLLER ERROR: " + e.getMessage());
//					        Map<String, String> error = new HashMap<>();
//					        error.put("error", e.getMessage());
//					        return ResponseEntity.badRequest().body(error);
//					    }
//					}

					
//					@PostMapping("/reset-password-with-auth")
//					public ResponseEntity<?> resetPasswordWithAuth(@Valid @RequestBody ResetPasswordWithAuthRequest request) {
//					    try {
//					        System.out.println("ğŸ” CONTROLLER: Reset password for: " + request.getUsername());
//					        User user = userRepository.findByUsername(request.getUsername())
//					            .orElseThrow(() -> new RuntimeException("User not found"));
//					        
//					        user.setPassword(passwordEncoder.encode(request.getNewPassword()));
//					        userRepository.save(user);
//					        
//					        Map<String, String> response = new HashMap<>();
//					        response.put("message", "Password reset successfully");
//					        return ResponseEntity.ok(response);
//					    } catch (Exception e) {
//					        System.err.println("ğŸ” CONTROLLER ERROR: " + e.getMessage());
//					        Map<String, String> error = new HashMap<>();
//					        error.put("error", e.getMessage());
//					        return ResponseEntity.badRequest().body(error);
//					    }
//					}
			
					
					
					
					
					
					
					
					
					
					
//					
//					@PostMapping("/forgot-password")
//					public ResponseEntity<?> forgotPassword(@Valid @RequestBody AuthRequest request) {
//					    try {
//					        System.out.println("ğŸ”¥ğŸ”¥ğŸ”¥ CONTROLLER: Forgot password request received for: " + request.getUsername());
//					        String resetToken = authService.generateResetToken(request.getUsername());
//					        System.out.println("ğŸ”¥ğŸ”¥ğŸ”¥ CONTROLLER: Generated Reset Token: " + resetToken);
//					        
//					        Map<String, Object> response = new HashMap<>();
//					        response.put("resetToken", resetToken);
//					        response.put("message", "Reset token generated. Check console for testing.");
//					        response.put("resetLink", "index.html?token=" + resetToken);
//					        return ResponseEntity.ok(response);
//					    } catch (Exception e) {
//					        System.err.println("ğŸ”¥ğŸ”¥ğŸ”¥ CONTROLLER ERROR in forgot-password: " + e.getMessage());
//					        e.printStackTrace();
//					        Map<String, String> error = new HashMap<>();
//					        error.put("error", e.getMessage());
//					        return ResponseEntity.badRequest().body(error);
//					    }
//					}
					

					
					
					
					
					
					
			
					
					
//					
//					@PostMapping("/reset-password")
//						public ResponseEntity<?> resetPassword(@Valid @RequestBody ResetPasswordRequest request){
//							try {
//					            System.out.println("ğŸ”¥ğŸ”¥ğŸ”¥ CONTROLLER: Reset password request received");
//						            System.out.println("ğŸ”¥ğŸ”¥ğŸ”¥ CONTROLLER: Token: " + request.getToken());
//						            System.out.println("ğŸ”¥ğŸ”¥ğŸ”¥ CONTROLLER: New Password: " + request.getNewPassword());
//
//						            // Call service method to reset password
//						            authService.resetPassword(request.getToken(), request.getNewPassword());
//							            Map<String, String> response = new HashMap<>();
//							            response.put("message", "Password reset successfully");
//
//							           return ResponseEntity.ok(response);
//								}
//							catch (Exception e)
//							{
//								System.err.println("ğŸ”¥ğŸ”¥ğŸ”¥ CONTROLLER ERROR: " + e.getMessage());
//								e.printStackTrace(); // Print full stack trace
//								Map<String, String> error = new HashMap<>();
//								error.put("error", e.getMessage());
//							return ResponseEntity.badRequest().body(error);
//							}
//						}
//						
//						public AuthController(AuthService authService) {
//						    this.authService = authService;
//						    System.out.println("LOADED SERVICE = " + authService.getClass());
//						}
}